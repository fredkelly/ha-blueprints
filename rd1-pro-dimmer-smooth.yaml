blueprint:
  name: RD1-Pro Brightness & On/Off Control (Zigbee2MQTT)
  description: Control brightness and toggle on/off using RD1-Pro rotary dimmer, selecting the switch device directly
  domain: automation
  input:
    remote_device:
      name: RD1-Pro Device
      description: Select the RD1-Pro device in Home Assistant (Zigbee2MQTT)
      selector:
        device:
          filter:
            - model_id: C-ZB-RD1P-REM
            - model_id: C-ZB-RD1P-DPM

    target_lights:
      name: Target Lights
      description: Lights or light groups to control
      selector:
        target:
          entity:
            domain: light
    brightness_step:
      name: Brightness Step (%)
      default: 3
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"
    transition_time:
      name: Transition Time (seconds)
      default: 0.2
      selector:
        number:
          min: 0
          max: 1
          step: 0.05

trigger:
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: pressed
    id: toggle_lights
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: started_rotating_right
    id: rotate_right
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: rotating_right
    id: rotate_right
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: started_rotating_left
    id: rotate_left
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: rotating_left
    id: rotate_left

variables:
  negative_step: "{{ -1 * (!input brightness_step | int) }}"

action:
  - choose:
      - conditions:
          - condition: trigger
            id: toggle_lights
        sequence:
          - service: light.toggle
            target: !input target_lights

      - conditions:
          - condition: trigger
            id: rotate_right
        sequence:
          - service: light.turn_on
            target: !input target_lights
            data:
              brightness_step_pct: !input brightness_step
              transition: !input transition_time

      - conditions:
          - condition: trigger
            id: rotate_left
        sequence:
          - service: light.turn_on
            target: !input target_lights
            data:
              brightness_step_pct: "{{ negative_step }}"
              transition: !input transition_time

